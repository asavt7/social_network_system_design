# System Design социальной сети для курса

System Design социальной сети для курса по [System Design](https://balun.courses/courses/system_design)



## Functional requirements:

- публикация постов из путешествий с фотографиями, небольшим описанием и привязкой к конкретному месту путешествия
- оценка и комментарии постов других путешественников
- подписка на других путешественников, чтобы следить за их активностью
- поиск популярных мест для путешествий и просмотр постов с этих мест
- просмотр ленты других путешественников


## Non-functional requirements:

- 10 000 000 DAU
- линейный рост числа пользователей (+ 10 000 000 DAU в год)
- availability 99,95%
- Храним пользовательские данные всегда
- Сезонность - 3 месяца (июнь-авг)


- Активность:
  - Подписки:
    - Пользователь в среднем имеет 30 подписок
    - Подписка на других пользователей - в среднем 1 раз в месяц
    - Получить список подписок - в среднем 1 раз в месяц
  - Публикация постов:
    - в среднем 1 пост в месяц
    - в сезон - в среднем 5 постов в месяц
  - Просмотр ленты:
    - в среднем 10 запросов в день
  - Реакции:
    - в среднем 5 реaкций в день
  - Комментарии:
    - в среднем пользователь публикует 1 комментарий в день
    - в среднем пользователь просматривает комментарии под 5 постами


- Лимиты и ограничения:
  - Подписки:
    - Пользователь может иметь не более 1000 подписок
    - Пользователь может подписываться не более чем на 100 новых пользователей в день
  - Публикация постов:
    - Пользователь может оставить не более 20 постов в день
    - Описание поста - не более 250 символов
    - Не более 10 изображений на пост
    - Размер изображения до 8 МБ
  - Реакции:
    - Пользователь может оставить не более 1000 реакций в день
  - Комментарии:
    - Пользователь может оставить не более 100 комментариев в день
    - Размер комментария - до 500 символов


- Временные ограничения:
  - Подписки:
    - Подписаться - 3 секунды (0.9q)
    - Получить список подписок - 3 секунды (0.9q)
  - Публикация постов:
    - Загрузка одного изображения - 10 секунд (0.9q)
    - Создание поста - 5 секунд (0.9q)
    - Новые посты появляются в лентах подписчиков в течение 10 минут
  - Просмотр ленты:
    - Получить следующую страницу ленты - 3 секунды (0.9q)
  - Реакции:
    - Новые реакции обновляются на постах в течение 10 минут
  - Комментарии:
    - Оставить комментарий - 5 секунд (0.9q)
    - Просмотр комментариев под постом - 3 секунды (0.9q)


## Basic calculations

- Connections = 10 000 000 * 0.1 = 1 000 000 соединений

- Replication Factor (RF) = 3

### Подписки:

Предположения:
  - В среднем пользователь имеет 30 подписок
  - Подписка 16B
    - 2 id пользователя = 2 * 8B 

RPS:
  - Подписаться - в среднем 1 раз в месяц = dau * 1 / 30 / 86400 = 3.9 ~= 4 RPS
  - Список подписок - в среднем 1 раз в месяц = dau * 1 / 30 / 86400 = 3.9 ~= 4 RPS

Traffic:
  - WRITE 4 * 16 B ~= 0.1 KB/s
  - READ 4 * 16 * 30 B ~= 2 KB/s

Disk: 15 GB
  - 30 подписок на пользователя * dau * 16 B ~= 5 GB
  - С учетом RF - 5 * 3 = 15 GB


### Посты
Предположения:
  - средний пост содержит 2 фото размером 5 МБ 
  - средний пост: ~0.5 KB
    - 200 символов unicode = 400B
    - id = 8B
    - user_id = 8B
    - timestamp = 8B
    - ссылки на связанные фото = несколько uuid - 2 * 16B = 32B
    - связанная локация 24B
      - координаты 16B
      - связаннаый идентификатор 8B

RPS:
  - в среднем 1 пост в месяц = dau * 1 / 30 / 86400 = 3.9 ~= 4 RPS
    - загрузка фото - 2 * 4 = 8 RPS
  - в сезон - в среднем 5 постов в месяц = dau * 5 / 30 / 86400 = 19.3 ~= 20 RPS
    - загрузка фото - 2 * 20 = 40 RPS

Traffic:
  - Посты:
    - WRITE 4 * 0.5 KB = 2 KB/s
    - WRITE 20 * 0.5 KB = 10 KB/s (в сезон)
  - Файлы:
    - WRITE (фото) - 4 RPS (посты) * 2 (фото в каждом посте) * 5 MB = 40 MB/s
    - WRITE (фото) - 40 * 5 MB = 200 MB/s (в сезон)
    
Disk на год: 
  - Посты: 378 GB
    - 31_536_000 s * 2 KB/s = 63_072_000 KB = 63 GB
    - (с учетом нагрузки в сезон) 31_536_000 s * 10 KB/s = 315_360_000 KB = 315 GB
    - сезон - занимает 1/4 часть рассчетного интервала - 63 * 3/4 + 315 * 1/4 = 126 GB
    - С учетом RF - 126 * 3 = 378 GB
  - Файлы: 7.8 PB
    - 31_536_000 s * 40 MB/s = 1_261_440_000 MB = 1.3 PB
    - (с учетом нагрузки в сезон) 31_536_000 s * 200 MB/s = 315_360_000 KB = 6.3 PB
    - сезон - занимает 1/4 часть рассчетного интервала - 1.3 PB * 3/4 + 6.3 * 1/4 = 2.6 PB
    - С учетом RF - 2.6 * 3 = 7.8 PB


### Ленты

Предположения:
  - в среднем 10 запросов в день
  - За запрос получаем до 25 постов
  - Средний размер картинки в посте 1 МБ c учетом сжатия, оригинал картинки пользователь смотрит редко.
  - Размер ленты для пользователя в БД - 2.5 KB
    - id = 8 B
    - пусть хранится 300 последних постов = 8 * 300 = 2_400 B 
  
RPS:
  - Получить страницу ленты = dau * 10 / 86400 = 1157 ~= 1200 RPS

Traffic:
  - Лента с постами:
    - READ 1200 RPS * (средний размер поста) * (количество постов на странице) ~= 1200 RPS * 0.5 KB * 25 = 15 MB/s
  - Фото в постах ленты:
    - READ 1200 RPS * (средний размер фото) * (количество постов на странице) * (количество фото в одном посте) = 1200 RPS * 1 MB * 25 * 2 = 60 GB/s

Disk на год: 75 GB
  - dau * 2.5 KB ~= 25 GB
  - С учетом RF - 5 * 3 = 75 GB


### Реакции

Предположения:
  - в среднем 10 запросов в день
  - Реакция занимает 16B
    - id пользователя 8B + id поста 8B
  
RPS:
  - Поставить реакцию dau * 5 / 86400 = 1157 ~= 600 RPS

Traffic:
  - WRITE 600 RPS * (средний размер ) ~= 600 RPS * 16 B ~= 1 KB/s

Disk на год: 96 GB
  - 31_536_000 * 1 KB/s = 31_536_000 KB = 32 GB
  - С учетом RF - 32 * 3 = 96 GB


### Комментарии
Предположения:
  - в среднем пользователь публикует 1 комментарий в день
  - в среднем пользователь просматривает комментарии под 5 постами
  - под средним постом - 5 комментов
  - средний коммент 100 символов + метадата = 250B

  
RPS:
  - Оставить комментарий = dau * 1 / 86400 ~= 120 RPS
  - Просмотр комментариев = dau * 5 / 86400 ~= 600 RPS

Traffic:
  - WRITE 120 RPS * (средний размер) ~= 120 RPS * 250 B = 30 KB/s
  - READ 600 RPS * (средний размер) * (количество комментариев) ~= 600 RPS * 250 B * 5 = 750 KB/s


Disk на год: 2.9 TB
  - 31_536_000 * 30 KB/s = 946_080_000 KB = 946 GB
  - С учетом RF - 946 * 3 = 2838 GB ~= 2.9 TB


### Итог:

Traffic:
  - WRITE = 0.1 KB/s + 2 KB/s + 1 KB/s + 30 KB/s ~= 35 KB/s
  - WRITE (файлы) = 40 MB/s
  - READ = 2 KB/s + 15 MB/s +  750 KB/s ~= 16 MB/s
  - READ (файлы) = 60 GB/s
  - System is read-intensive

Disk на год:
  - Данные: 15 GB + 378 GB +75 GB + 96 GB + 2.9 TB = 3.5 TB
  - Файлы: 7.8 PB
